<div class="return-tab-container">
  <!-- Success State -->
  <div class="success-state" *ngIf="returnScheduled && scheduledAppointment">
    <div class="success-icon">
      <app-icon name="check" [size]="48"></app-icon>
    </div>
    <h2>Retorno Agendado!</h2>
    <p class="success-message">O retorno foi agendado com sucesso.</p>
    
    <div class="scheduled-info">
      <div class="info-item">
        <app-icon name="calendar" [size]="18"></app-icon>
        <span>{{ scheduledAppointment.date | date:'fullDate':'':'pt-BR' }}</span>
      </div>
      <div class="info-item">
        <app-icon name="clock" [size]="18"></app-icon>
        <span>{{ scheduledAppointment.time }}</span>
      </div>
      <div class="info-item">
        <app-icon name="user" [size]="18"></app-icon>
        <span>{{ appointment?.professionalName }}</span>
      </div>
    </div>

    <app-button variant="outline" (click)="scheduleAnother()" *ngIf="!readonly">
      <app-icon name="check" [size]="16"></app-icon>
      Concluir
    </app-button>
  </div>

  <!-- List View - Show existing returns -->
  <ng-container *ngIf="!returnScheduled && viewMode === 'list'">
    <div class="header">
      <div class="header-content">
        <div class="title-section">
          <app-icon name="calendar" [size]="24" />
          <div>
            <h2>Retornos</h2>
            <p class="subtitle">{{ appointment?.specialtyName }} - {{ appointment?.professionalName }}</p>
          </div>
        </div>
      </div>
      <div class="header-actions" *ngIf="!readonly">
        <app-button variant="primary" size="sm" (click)="startNewReturn()">
          <app-icon name="plus" [size]="16"></app-icon>
          Novo Retorno
        </app-button>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="isLoadingReturns">
      <app-icon name="clock" [size]="32"></app-icon>
      <p>Carregando retornos...</p>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="!isLoadingReturns && existingReturns.length === 0">
      <app-icon name="calendar" [size]="48"></app-icon>
      <h4>Nenhum retorno agendado</h4>
      <p>Clique em "Novo Retorno" para agendar um retorno para esta consulta.</p>
    </div>

    <!-- Returns List -->
    <div class="returns-list" *ngIf="!isLoadingReturns && existingReturns.length > 0">
      <div class="return-card" *ngFor="let ret of existingReturns">
        <div class="return-header">
          <div class="return-date">
            <app-icon name="calendar" [size]="18"></app-icon>
            <span>{{ ret.date | date:'fullDate':'':'pt-BR' }}</span>
          </div>
          <span class="status-badge" [ngClass]="getStatusClass(ret.status)">
            {{ getStatusLabel(ret.status) }}
          </span>
        </div>
        <div class="return-details">
          <div class="detail-item">
            <app-icon name="clock" [size]="16"></app-icon>
            <span>{{ ret.time }}</span>
          </div>
          <div class="detail-item" *ngIf="ret.observation">
            <app-icon name="file" [size]="16"></app-icon>
            <span>{{ ret.observation }}</span>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Scheduling Flow -->
  <ng-container *ngIf="!returnScheduled && viewMode === 'scheduling' && !readonly">
    <div class="header">
      <div class="header-content">
        <app-button variant="ghost" size="sm" (click)="backToList()">
          <app-icon name="arrow-left" [size]="16"></app-icon>
          Voltar
        </app-button>
        <div class="title-section">
          <app-icon name="calendar" [size]="24" />
          <div>
            <h2>Agendar Retorno</h2>
            <p class="subtitle">{{ appointment?.specialtyName }} - {{ appointment?.professionalName }}</p>
          </div>
        </div>
      </div>
    </div>

    <div class="stepper">
      <ng-container *ngFor="let step of steps; let i = index; let last = last">
        <div 
          class="step-item" 
          [class.active]="step.id === currentStep"
          [class.completed]="i < getStepIndex(currentStep)"
          [class.disabled]="i > getStepIndex(currentStep)"
          (click)="goToStep(step.id)">
          <div class="step-circle">
            <app-icon *ngIf="i < getStepIndex(currentStep)" name="check" [size]="12"></app-icon>
            <span *ngIf="i >= getStepIndex(currentStep)">{{ i + 1 }}</span>
          </div>
          <span class="step-label">{{ step.label }}</span>
        </div>
        <div *ngIf="!last" class="step-line" [class.completed]="i < getStepIndex(currentStep)"></div>
      </ng-container>
    </div>

    <!-- Step 1: Date Selection -->
    <div class="step-content" *ngIf="currentStep === 'date'">
      <div class="step-header">
        <h3>Selecione uma data para o retorno</h3>
      </div>

      <div class="calendar-container">
        <div class="calendar-header">
          <app-button variant="ghost" size="sm" (click)="changeMonth(-1)">
            <app-icon name="arrow-left" [size]="16"></app-icon>
          </app-button>
          <h4>{{ currentMonth | date:'MMMM yyyy':'':'pt-BR' }}</h4>
          <app-button variant="ghost" size="sm" (click)="changeMonth(1)">
            <app-icon name="arrow-right" [size]="16"></app-icon>
          </app-button>
        </div>

        <div class="calendar-grid">
          <div class="weekday" *ngFor="let day of weekDays">{{ day }}</div>
          
          <div class="day" 
               *ngFor="let day of calendarDays"
               [class.disabled]="!day.available"
               [class.selected]="selectedDate?.getTime() === day.date.getTime()"
               (click)="selectDate(day)">
            <span class="day-number">{{ day.date | date:'d' }}</span>
            <div class="day-info" *ngIf="day.available">
              <span class="slots">{{ day.slots }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 2: Time Slots -->
    <div class="step-content" *ngIf="currentStep === 'time'">
      <div class="step-header">
        <h3>Horários Disponíveis</h3>
        <p>{{ selectedDate | date:'fullDate':'':'pt-BR' }}</p>
      </div>

      <div class="loading-state" *ngIf="loading">
        <app-icon name="clock" [size]="32"></app-icon>
        <p>Carregando horários...</p>
      </div>

      <div class="slots-list" *ngIf="!loading">
        <div class="slot-item" *ngFor="let slot of availableSlots" (click)="selectSlot(slot)">
          <div class="time">{{ slot.time }}</div>
          <div class="slot-details">
            <span>Disponível</span>
          </div>
          <app-icon name="arrow-right" [size]="16"></app-icon>
        </div>

        <div class="empty-state" *ngIf="availableSlots.length === 0">
          <p>Nenhum horário disponível para esta data.</p>
          <app-button variant="outline" size="sm" (click)="goBack()">
            Escolher outra data
          </app-button>
        </div>
      </div>
    </div>

    <!-- Step 3: Confirmation -->
    <div class="step-content" *ngIf="currentStep === 'confirmation'">
      <div class="step-header">
        <h3>Confirmar Retorno</h3>
        <p>Verifique os dados antes de confirmar</p>
      </div>

      <div class="confirmation-card">
        <div class="info-row">
          <label>Especialidade</label>
          <p>{{ appointment?.specialtyName }}</p>
        </div>
        <div class="info-row">
          <label>Profissional</label>
          <p>{{ appointment?.professionalName }}</p>
        </div>
        <div class="info-row">
          <label>Data</label>
          <p>{{ selectedDate | date:'fullDate':'':'pt-BR' }}</p>
        </div>
        <div class="info-row">
          <label>Horário</label>
          <p>{{ selectedSlot?.time }}</p>
        </div>

        <div class="observation-input">
          <label>Observação (Opcional)</label>
          <textarea [(ngModel)]="observation" placeholder="Alguma observação adicional?"></textarea>
        </div>
      </div>

      <div class="actions">
        <app-button variant="outline" (click)="goBack()">Voltar</app-button>
        <app-button variant="primary" (click)="confirmScheduling()" [loading]="loading">
          <app-icon name="check" [size]="16"></app-icon>
          Confirmar Retorno
        </app-button>
      </div>
    </div>
  </ng-container>
</div>